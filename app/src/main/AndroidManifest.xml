<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools">

    <!-- 基础权限 -->
    <uses-permission android:name="android.permission.RECORD_AUDIO" />
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
    <uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
    <uses-permission android:name="android.permission.CHANGE_NETWORK_STATE" />
    <uses-permission android:name="android.permission.READ_PHONE_STATE" />
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" 
        android:maxSdkVersion="32" />
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"
        android:maxSdkVersion="32" />

    <!-- 前台服务权限 -->
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE_SPECIAL_USE" />
    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />

    <!-- 后台保活权限 -->
    <uses-permission android:name="android.permission.WAKE_LOCK" />
    <uses-permission android:name="android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS" />

    <!-- 查询所有已安装应用的权限 (Android 11+) -->
    <uses-permission android:name="android.permission.QUERY_ALL_PACKAGES"
        tools:ignore="QueryAllPackagesPermission" />

    <!-- AppOps 统计权限 (通过 Shizuku 授予) -->
    <uses-permission android:name="android.permission.GET_APP_OPS_STATS" />

    <!-- 写入安全设置权限 (通过 Shizuku 授予，用于自动开启无障碍服务) -->
    <uses-permission android:name="android.permission.WRITE_SECURE_SETTINGS" />

    <!-- 悬浮窗权限 (用于后台启动 Activity) -->
    <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />
    
    <!-- 振动权限 (用于悬浮球录音反馈) -->
    <uses-permission android:name="android.permission.VIBRATE" />

    <!-- 短信权限 -->
    <uses-permission android:name="android.permission.READ_SMS" />
    <uses-permission android:name="android.permission.SEND_SMS" />
    <uses-permission android:name="android.permission.RECEIVE_SMS" />

    <!-- 通讯录权限 -->
    <uses-permission android:name="android.permission.READ_CONTACTS" />
    <uses-permission android:name="android.permission.WRITE_CONTACTS" />
    <uses-permission android:name="android.permission.GET_ACCOUNTS" />

    <!-- 电话权限 -->
    <uses-permission android:name="android.permission.CALL_PHONE" />
    <uses-permission android:name="android.permission.READ_CALL_LOG" />
    <uses-permission android:name="android.permission.WRITE_CALL_LOG" />
    <uses-permission android:name="android.permission.ANSWER_PHONE_CALLS" />
    <uses-permission android:name="android.permission.PROCESS_OUTGOING_CALLS" />

    <!-- 日历权限 -->
    <uses-permission android:name="android.permission.READ_CALENDAR" />
    <uses-permission android:name="android.permission.WRITE_CALENDAR" />

    <!-- 定时任务权限 -->
    <uses-permission android:name="com.android.alarm.permission.SET_ALARM" />
    <uses-permission android:name="android.permission.SCHEDULE_EXACT_ALARM" />
    <uses-permission android:name="android.permission.USE_FULL_SCREEN_INTENT" />
    <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" />

    <application
        android:name="top.yling.ozx.guiagent.MyApplication"
        android:allowBackup="true"
        android:dataExtractionRules="@xml/data_extraction_rules"
        android:fullBackupContent="@xml/backup_rules"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher"
        android:supportsRtl="true"
        android:theme="@style/Theme.Xiaoling"
        android:usesCleartextTraffic="true">
        
        <!-- Login Activity (Launch Entry) -->
        <activity
            android:name="top.yling.ozx.guiagent.LoginActivity"
            android:exported="true"
            android:screenOrientation="portrait">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>

        <!-- Register Activity -->
        <activity
            android:name="top.yling.ozx.guiagent.RegisterActivity"
            android:exported="false"
            android:screenOrientation="portrait"
            android:parentActivityName="top.yling.ozx.guiagent.LoginActivity" />

        <activity
            android:name="top.yling.ozx.guiagent.MainActivity"
            android:exported="false"
            android:screenOrientation="portrait"
            android:windowSoftInputMode="adjustResize" />

        <activity
            android:name="top.yling.ozx.guiagent.AccessibilityTestActivity"
            android:exported="false"
            android:screenOrientation="portrait" />

        <!-- 虚拟屏幕测试页面 -->
        <activity
            android:name="top.yling.ozx.guiagent.VirtualDisplayTestActivity"
            android:exported="false"
            android:screenOrientation="portrait"
            android:parentActivityName="top.yling.ozx.guiagent.AccessibilityTestActivity" />

        <!-- 无障碍服务 -->
        <service
            android:name="top.yling.ozx.guiagent.MyAccessibilityService"
            android:exported="true"
            android:permission="android.permission.BIND_ACCESSIBILITY_SERVICE">
            <intent-filter>
                <action android:name="android.accessibilityservice.AccessibilityService" />
            </intent-filter>
            <meta-data
                android:name="android.accessibilityservice"
                android:resource="@xml/accessibility_service_config" />
        </service>

        <!-- WebSocket 前台服务 -->
        <service
            android:name="top.yling.ozx.guiagent.websocket.WebSocketService"
            android:exported="false"
            android:foregroundServiceType="specialUse">
            <property
                android:name="android.app.PROPERTY_SPECIAL_USE_FGS_SUBTYPE"
                android:value="websocket_connection" />
        </service>

        <!-- Agent覆盖层服务（状态指示灯、边框光晕） -->
        <service
            android:name="top.yling.ozx.guiagent.AgentOverlayService"
            android:exported="false"
            android:foregroundServiceType="specialUse">
            <property
                android:name="android.app.PROPERTY_SPECIAL_USE_FGS_SUBTYPE"
                android:value="agent_overlay" />
        </service>
        
        <activity
            android:name="top.yling.ozx.guiagent.SettingsActivity"
            android:exported="false"
            android:screenOrientation="portrait"
            android:parentActivityName="top.yling.ozx.guiagent.MainActivity" />

        <!-- 高级设置页面 -->
        <activity
            android:name="top.yling.ozx.guiagent.AdvancedSettingsActivity"
            android:exported="false"
            android:screenOrientation="portrait"
            android:parentActivityName="top.yling.ozx.guiagent.SettingsActivity" />

        <!-- 权限引导页面 -->
        <activity
            android:name="top.yling.ozx.guiagent.PermissionGuideActivity"
            android:exported="false"
            android:screenOrientation="portrait"
            android:theme="@style/Theme.Xiaoling" />

        <!-- 任务历史页面 -->
        <activity
            android:name="top.yling.ozx.guiagent.TaskHistoryActivity"
            android:exported="false"
            android:screenOrientation="portrait"
            android:parentActivityName="top.yling.ozx.guiagent.MainActivity" />

        <!-- 技能列表页面 -->
        <activity
            android:name="top.yling.ozx.guiagent.SkillListActivity"
            android:exported="false"
            android:screenOrientation="portrait"
            android:parentActivityName="top.yling.ozx.guiagent.SettingsActivity" />

        <!-- 技能编辑页面 -->
        <activity
            android:name="top.yling.ozx.guiagent.SkillEditActivity"
            android:exported="false"
            android:screenOrientation="portrait"
            android:parentActivityName="top.yling.ozx.guiagent.SkillListActivity" />

        <!-- 透明跳板 Activity，用于从后台启动其他应用 -->
        <activity
            android:name="top.yling.ozx.guiagent.LaunchBridgeActivity"
            android:exported="false"
            android:theme="@android:style/Theme.Translucent.NoTitleBar"
            android:excludeFromRecents="true"
            android:noHistory="true"
            android:taskAffinity=""
            android:launchMode="singleInstance" />

        <!-- AI Agent 列表页面 -->
        <activity
            android:name="top.yling.ozx.guiagent.AgentListActivity"
            android:exported="false"
            android:screenOrientation="portrait"
            android:parentActivityName="top.yling.ozx.guiagent.MainActivity" />

        <!-- AI Agent 聊天窗口页面 -->
        <activity
            android:name="top.yling.ozx.guiagent.ChatActivity"
            android:exported="false"
            android:screenOrientation="portrait"
            android:windowSoftInputMode="adjustResize"
            android:parentActivityName="top.yling.ozx.guiagent.AgentListActivity" />

        <!-- FollowUp 问题回答 Activity / Chat 消息显示 Activity -->
        <activity
            android:name="top.yling.ozx.guiagent.FollowUpAnswerActivity"
            android:exported="false"
            android:screenOrientation="portrait"
            android:theme="@style/Theme.Xiaoling.BottomSheet"
            android:launchMode="singleTop"
            android:windowSoftInputMode="adjustPan"
            android:showOnLockScreen="true"
            android:turnScreenOn="true"
            android:showWhenLocked="true" />

        <!-- LifeAssistant Activity - 生活助手信息展示 -->
        <activity
            android:name="top.yling.ozx.guiagent.LifeAssistantActivity"
            android:exported="false"
            android:screenOrientation="portrait"
            android:theme="@style/Theme.Xiaoling"
            android:launchMode="singleTop"
            android:showOnLockScreen="true"
            android:turnScreenOn="true"
            android:showWhenLocked="true" />

        <!-- 定时任务管理页面 -->
        <activity
            android:name="top.yling.ozx.guiagent.scheduler.ui.ScheduledTaskActivity"
            android:exported="false"
            android:screenOrientation="portrait"
            android:theme="@style/Theme.Xiaoling.NoActionBar"
            android:parentActivityName="top.yling.ozx.guiagent.MainActivity" />

        <!-- 定时任务全屏提醒 Activity -->
        <activity
            android:name="top.yling.ozx.guiagent.app.activity.ReminderAlertActivity"
            android:excludeFromRecents="true"
            android:launchMode="singleInstance"
            android:showOnLockScreen="true"
            android:turnScreenOn="true" />

        <!-- 定时任务广播接收器 -->
        <!-- 开机自启动接收器 -->
        <receiver
            android:name="top.yling.ozx.guiagent.scheduler.BootCompletedReceiver"
            android:enabled="true"
            android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.BOOT_COMPLETED" />
            </intent-filter>
        </receiver>

        <!-- 时区变化接收器 -->
        <receiver
            android:name="top.yling.ozx.guiagent.scheduler.TimezoneChangeReceiver"
            android:enabled="true"
            android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.TIMEZONE_CHANGED" />
            </intent-filter>
        </receiver>

        <!-- 自动化任务执行接收器 -->
        <receiver
            android:name="top.yling.ozx.guiagent.scheduler.AutomationTaskReceiver"
            android:enabled="true"
            android:exported="false">
            <intent-filter>
                <action android:name="top.yling.ozx.guiagent.ACTION_EXECUTE_TASK" />
            </intent-filter>
        </receiver>

        <!-- 提醒降级方案接收器 -->
        <receiver
            android:name="top.yling.ozx.guiagent.scheduler.ReminderReceiver"
            android:enabled="true"
            android:exported="false" />

        <!-- Shizuku Provider - 用于高级操作 -->
        <provider
            android:name="rikka.shizuku.ShizukuProvider"
            android:authorities="${applicationId}.shizuku"
            android:multiprocess="false"
            android:enabled="true"
            android:exported="true"
            android:permission="android.permission.INTERACT_ACROSS_USERS_FULL" />

        <!-- Config Provider - 跨进程共享配置数据（如 displayId） -->
        <provider
            android:name="top.yling.ozx.guiagent.provider.ConfigProvider"
            android:authorities="top.yling.ozx.guiagent.provider"
            android:exported="true"
            android:grantUriPermissions="true" />
    </application>

</manifest>